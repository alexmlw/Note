---
title: 'Section 4: Gapminder'
author: "Alexander Troynin"
date: "05 06 2018"
output: html_document
---

Ханс Рослинг был соучредителем Фонда Gapminder, организации
посвятившей обучению общественности используя данные, развеивали
распространенные мифы о так называемом развивающемся мире.
Организация использует данные, чтобы показать, какие актуальные
тенденции в области здравоохранения и экономики противоречат
повествованиям, которые исходят от сенсационных СМИ охват катастроф,
трагедий и других неудачных событий.

Установим пакет данных:

```r
install.packages("gapminder")
library(gapminder)
```

Или загрузить dslabs который тоже содержит некоторые данные от gapminder:

```{r}
library(dslabs)
library(dplyr)
data("gapminder")
head(gapminder)
```

Протестируем наши знания на различиях детской смертности в разных странах.

```{r}
gapminder %>%
  filter(year == 2015 & country %in% c("Sri Lanka", "Turkey")) %>%
  select(country, infant_mortality)
```

Видим, что Шри-Ланка имеет более низкую смертность, чем Турция.

Есьить предвзятое понятие что мир разделен на две группы, 
Западный мир, который составляет Западная Европа и Северная
Америка, которые характеризуется длительным сроком жизни и
небольшими семьями по сравнению с развивающимися странами мира,
Африки, Азии и Латинской Америки, характеризуются короткими сроками
жизни и многодетными семьями.

Но поддерживают ли данные этот дихотомический взгляд на мир?

Первое, что мы делаем, чтобы увидеть, какие данные должны говорить
об этом мировоззрении, является диаграммой ожидаемой продолжительности
жизни по сравнению с коэффициентами рождаемости. Коэффициенты рождаемости
определяются как среднее число детей на одну женщину.

Мы начнем с рассмотрения данных примерно через 50 лет

```{r}
library(ggplot2)
ds_theme_set()

filter(gapminder, year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point()
```

Мы можем посмотреть данные за 2012 год также как и за 1962 год.
Но для сравнения предпочтительно графики расположить бок о бок.

Разделим на континенты и года:

```{r}
filter(gapminder, year%in%c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_grid(continent~year)
```

Если мы хотим сравнить только года, тогда функция **facet_grid()**
принимает один аргумент:

```{r}
filter(gapminder, year%in%c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_grid(~year)
```

Просмотреть серию графиков по разным годам:

```{r}
years <- c(1962, 1980, 1990, 2000, 2012)
continents <- c("Europe", "Asia")
gapminder %>%
  filter(year%in%years & continent%in%continents) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_wrap(~year)
```

Данные взятые из одной страны плотно упакованы точками и мы можем
создать линию:

```{r}
gapminder %>% filter(country == "United States") %>%
  ggplot(aes(year, fertility)) +
  geom_point()
gapminder %>% filter(country == "United States") %>%
  ggplot(aes(year, fertility)) +
  geom_line()
```

Это особенно полезно когда смотришь на две страны:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility)) +
  geom_line()
```

Но мы получили не то что хотели. Это связяно с тем что мы
не сообщили ggplot о разделении графика двумя линиями.
Для этого групируем данный по странам:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility, group = country)) +
  geom_line()
```

Уже лучше, но затрудняемся ответитькакая линия показывает
данные какой страны? Решить это можно с помошью цвета,
ggplot автоматически сгрупирует данные по значению цвета:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility, color = country)) +
  geom_line()
```

Добавим метки в график временных рядов чтобы посмотрет на
продолжительность жизни.

```{r}
labels <- data.frame(country = countries, x = c(1975, 1965), y = c(60, 72))
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, life_expectancy, color = country)) +
  geom_line() +
  geom_text(data = labels, aes(x,y, label = country), size = 5) +
  theme(legend.position = "none")
```

Добавим переменную доллар в день (dollars_per_day) в нашу таблицу данных.
ВВП, деленный на население, разделенный на 365 дней в году.

```{r}
gapminder <- gapminder %>%
  mutate(dollars_per_day = gdp/population/365)
```

Расмотрим гистограмму доходов в день с 1970 года.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black")
```

Мы видим, что для большинства стран, средние значения
составляют менее 10 долларов США в день. Однако большая
часть оси х посвящена 35 странам со средними значениями
выше 10 долларов. Возможно, было бы более информативно
быстрый способ увидеть, сколько стран делают в среднем
около 1 доллора в день, крайне бедные - $ 2 в день, очень
бедные - $ 4 в день, бедные - $ 8 в день, что примерно
среднее - $ 16 в день, которая является состоятельной
страной - 32 доллара богаты, а 64 доллара - очень богаты.

Эти изменения являются мультипликативными. И здесь мы вводим
преобразования log. Преобразования логарифма изменяют
мультипликативные изменения в аддитивные. Например,
использование базы 2 означает, что каждый раз, когда значение
удваивается, лог-преобразование увеличивается на единицу.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(log2(dollars_per_day))) +
  geom_histogram(binwidth = 1, color = "black")
```

Мы видим два явных уровня. Прежде чем продолжить интерпретацию
данных, представим часто используемый статистический язык.
В статистике эти уровни иногда называются режимами. Режим
распределения - это значение с наивысшей частотой. Режим
нормального распределения является средним. Когда распределение,
подобное тому, которое мы видим не монотонно уменьшается от режима,
мы называем место, где оно поднимается и опускается снова как
локальный режим. И мы говорим, что распределение имеет несколько
режимов. Гистограмма, свидетельствует о том, что в 1970 году
распределение доходов в стране имеют два режима. Один - около 2
долларов США в день, один в шкале log2, а другой около 32 долларов
США в день - 5 в шкале log2. Эта бимодальность согласуется с
дихотомическим миром состоящих из стран со средним доходом менее
8 долл. США в день, 3 на шкале логарифмаа. И страны, выше которых мы
видим два режима на гистограмме.

Теперь, прежде чем продолжить интерпретацию данных, выясним как мы
выбираем базу. И для гистограммы выше, мы выбрали основание 2. Другим 
общим выбором является натуральный логарифм с основанием 10.
Рекомендуется использовать натуральный логарифм для исследования данных 
при визуализации.

Еще одним следствием ограниченного диапазона является выбор ширины уровня
является более сложной задачей. С основанием уровня 2 мы знаем, что
его ширина 1 будет переводить в ячейки с диапазоном x до 2 на x.
В качестве примера, в котором основание 10 имеет больше смысла, чем
основание 2, рассмотрите размер популяции.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year) %>%
  ggplot(aes(log10(population))) +
  geom_histogram(binwidth = 0.5, color = "black")
```

Использование логарифма по основанию 10 здесь имеет больше смысла,
поскольку диапазон этих данных составляет от 45 000 до 800 миллионов.
Глядя на шкалу, зная, что основание логарифма равно 10, мы можем быстро
определить, что население страны колеблется от примерно 40 000 человек
до примерно миллиарда.

Существует два способа использования длинных преобразований на графиках.
Мы можем логарифмировать значения до вывода на график, или мы можем
использовать логарифмическую шкалу на оси. Оба подхода полезны и имеют
разные сильные стороны. Если мы логарифмируем данные, мы сможем легко
интерпретировать промежуточные значения в масштабе. Например, если мы
используем масштаб, который выглядит как это было логарифмически
преобразовано, мы знаем, что x равно 1,5. А высы регистрируются и у
нас есть x между 1 и 10, то мы не знаем что такое x, потому что от 10 до
1,5, и не просто посчитать в х голове. Однако преимущество использования
логарифмических весов, которые мы видим исходные значения на оси.

Этот способ имеет преимущество, потому что мы видим исходные значения,
отображаемые на графике, что позволяет очень легко быстро увидеть,
с какими цифрами мы имеем дело.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2")
```

Гистограмма выглядит точно так же. Разница заключается в том, что
в масштабах в оси х, вместо того, чтобы увидеть значение логарифма,
мы видим исходные значения на логарифмической шкале.

Гистограмма показала нам, что значения распределения доходов
показывают дихотомию. Однако гистограмма не показывает нам,
являются ли две группы стран западной и развивающейся.
Чтобы увидеть распределения по географическому региону, мы
сначала разбиваем данные на регионы, а затем изучаем распределение
для каждого.

Глядя на гистограммы или гладкие линии для каждого из них
не будут полезны. Вместо этого мы можем складывать box plots
рядом друг с другом.

```{r}
p <- gapminder %>%
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(region, dollars_per_day))

p + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Mожем увидеть, что на самом деле существует западная по сравнению с
остальной дихотомии. Если внимательно посмотрить на график, увидим,
что Северная Америка, Северная Европа, Австралия, Новой Зеландии
и Западной Европы находятся на высоком уровне. Есть еще несколько
корректировок, которые можно сделать.

Для начала переупорядочим регионы по их среднему уровню дохода,
так же добавим цвет континента:

```{r}
p <- gapminder %>%
  filter(year == past_year & !is.na(gdp)) %>%
  mutate(region = reorder(region, dollars_per_day, FUN = median)) %>%
  ggplot(aes(region, dollars_per_day, fill = continent)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("")

p
```

Теперь нужно изменить маштаб:

```{r}
p <-p + scale_y_continuous(trans = "log2")
p
```

Такой вид помогает видеть различия между странами с более низким доходом.
Например, мы видим разницу между африканским континентоми Азией.

Последнее что нужно сделать, что даст еще больше информации, состоит в том,
чтобы показать данные:

```{r}
p <- p + geom_point(show.legend = FALSE)
p
```

Во многих случаях мы не показываем данные, фактические отдельные
точки, потому что это добавляет слишком много беспорядка в график,
и это затуманивает сообщение. Но в этом конкретном примере у нас
не так много точек.

