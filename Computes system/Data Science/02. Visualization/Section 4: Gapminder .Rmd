---
title: 'Section 4: Gapminder'
author: "Alexander Troynin"
date: "05 06 2018"
output: html_document
---

Ханс Рослинг был соучредителем Фонда Gapminder, организации
посвятившей обучению общественности используя данные, развеивали
распространенные мифы о так называемом развивающемся мире.
Организация использует данные, чтобы показать, какие актуальные
тенденции в области здравоохранения и экономики противоречат
повествованиям, которые исходят от сенсационных СМИ охват катастроф,
трагедий и других неудачных событий.

Установим пакет данных:

```r
install.packages("gapminder")
library(gapminder)
```

Или загрузить dslabs который тоже содержит некоторые данные от gapminder:

```{r}
library(dslabs)
library(dplyr)
data("gapminder")
head(gapminder)
```

Протестируем наши знания на различиях детской смертности в разных странах.

```{r}
gapminder %>%
  filter(year == 2015 & country %in% c("Sri Lanka", "Turkey")) %>%
  select(country, infant_mortality)
```

Видим, что Шри-Ланка имеет более низкую смертность, чем Турция.

Есьить предвзятое понятие что мир разделен на две группы, 
Западный мир, который составляет Западная Европа и Северная
Америка, которые характеризуется длительным сроком жизни и
небольшими семьями по сравнению с развивающимися странами мира,
Африки, Азии и Латинской Америки, характеризуются короткими сроками
жизни и многодетными семьями.

Но поддерживают ли данные этот дихотомический взгляд на мир?

Первое, что мы делаем, чтобы увидеть, какие данные должны говорить
об этом мировоззрении, является диаграммой ожидаемой продолжительности
жизни по сравнению с коэффициентами рождаемости. Коэффициенты рождаемости
определяются как среднее число детей на одну женщину.

Мы начнем с рассмотрения данных примерно через 50 лет

```{r}
library(ggplot2)
ds_theme_set()

filter(gapminder, year == 1962) %>% 
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point()
```

Мы можем посмотреть данные за 2012 год также как и за 1962 год.
Но для сравнения предпочтительно графики расположить бок о бок.

Разделим на континенты и года:

```{r}
filter(gapminder, year%in%c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_grid(continent~year)
```

Если мы хотим сравнить только года, тогда функция **facet_grid()**
принимает один аргумент:

```{r}
filter(gapminder, year%in%c(1962, 2012)) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_grid(~year)
```

Просмотреть серию графиков по разным годам:

```{r}
years <- c(1962, 1980, 1990, 2000, 2012)
continents <- c("Europe", "Asia")
gapminder %>%
  filter(year%in%years & continent%in%continents) %>%
  ggplot(aes(fertility, life_expectancy, color = continent)) +
  geom_point() +
  facet_wrap(~year)
```

Данные взятые из одной страны плотно упакованы точками и мы можем
создать линию:

```{r}
gapminder %>% filter(country == "United States") %>%
  ggplot(aes(year, fertility)) +
  geom_point()
gapminder %>% filter(country == "United States") %>%
  ggplot(aes(year, fertility)) +
  geom_line()
```

Это особенно полезно когда смотришь на две страны:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility)) +
  geom_line()
```

Но мы получили не то что хотели. Это связяно с тем что мы
не сообщили ggplot о разделении графика двумя линиями.
Для этого групируем данный по странам:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility, group = country)) +
  geom_line()
```

Уже лучше, но затрудняемся ответитькакая линия показывает
данные какой страны? Решить это можно с помошью цвета,
ggplot автоматически сгрупирует данные по значению цвета:

```{r}
countries <- c("Germany", "South Korea")
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, fertility, color = country)) +
  geom_line()
```

Добавим метки в график временных рядов чтобы посмотрет на
продолжительность жизни.

```{r}
labels <- data.frame(country = countries, x = c(1975, 1965), y = c(60, 72))
gapminder %>% filter(country %in% countries) %>%
  ggplot(aes(year, life_expectancy, color = country)) +
  geom_line() +
  geom_text(data = labels, aes(x,y, label = country), size = 5) +
  theme(legend.position = "none")
```

Добавим переменную доллар в день (dollars_per_day) в нашу таблицу данных.
ВВП, деленный на население, разделенный на 365 дней в году.

```{r}
gapminder <- gapminder %>%
  mutate(dollars_per_day = gdp/population/365)
```

Расмотрим гистограмму доходов в день с 1970 года.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black")
```

Мы видим, что для большинства стран, средние значения
составляют менее 10 долларов США в день. Однако большая
часть оси х посвящена 35 странам со средними значениями
выше 10 долларов. Возможно, было бы более информативно
быстрый способ увидеть, сколько стран делают в среднем
около 1 доллора в день, крайне бедные - $ 2 в день, очень
бедные - $ 4 в день, бедные - $ 8 в день, что примерно
среднее - $ 16 в день, которая является состоятельной
страной - 32 доллара богаты, а 64 доллара - очень богаты.

Эти изменения являются мультипликативными. И здесь мы вводим
преобразования log. Преобразования логарифма изменяют
мультипликативные изменения в аддитивные. Например,
использование базы 2 означает, что каждый раз, когда значение
удваивается, лог-преобразование увеличивается на единицу.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(log2(dollars_per_day))) +
  geom_histogram(binwidth = 1, color = "black")
```

Мы видим два явных уровня. Прежде чем продолжить интерпретацию
данных, представим часто используемый статистический язык.
В статистике эти уровни иногда называются режимами. Режим
распределения - это значение с наивысшей частотой. Режим
нормального распределения является средним. Когда распределение,
подобное тому, которое мы видим не монотонно уменьшается от режима,
мы называем место, где оно поднимается и опускается снова как
локальный режим. И мы говорим, что распределение имеет несколько
режимов. Гистограмма, свидетельствует о том, что в 1970 году
распределение доходов в стране имеют два режима. Один - около 2
долларов США в день, один в шкале log2, а другой около 32 долларов
США в день - 5 в шкале log2. Эта бимодальность согласуется с
дихотомическим миром состоящих из стран со средним доходом менее
8 долл. США в день, 3 на шкале логарифмаа. И страны, выше которых мы
видим два режима на гистограмме.

Теперь, прежде чем продолжить интерпретацию данных, выясним как мы
выбираем базу. И для гистограммы выше, мы выбрали основание 2. Другим 
общим выбором является натуральный логарифм с основанием 10.
Рекомендуется использовать натуральный логарифм для исследования данных 
при визуализации.

Еще одним следствием ограниченного диапазона является выбор ширины уровня
является более сложной задачей. С основанием уровня 2 мы знаем, что
его ширина 1 будет переводить в ячейки с диапазоном x до 2 на x.
В качестве примера, в котором основание 10 имеет больше смысла, чем
основание 2, рассмотрите размер популяции.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year) %>%
  ggplot(aes(log10(population))) +
  geom_histogram(binwidth = 0.5, color = "black")
```

Использование логарифма по основанию 10 здесь имеет больше смысла,
поскольку диапазон этих данных составляет от 45 000 до 800 миллионов.
Глядя на шкалу, зная, что основание логарифма равно 10, мы можем быстро
определить, что население страны колеблется от примерно 40 000 человек
до примерно миллиарда.

Существует два способа использования длинных преобразований на графиках.
Мы можем логарифмировать значения до вывода на график, или мы можем
использовать логарифмическую шкалу на оси. Оба подхода полезны и имеют
разные сильные стороны. Если мы логарифмируем данные, мы сможем легко
интерпретировать промежуточные значения в масштабе. Например, если мы
используем масштаб, который выглядит как это было логарифмически
преобразовано, мы знаем, что x равно 1,5. А высы регистрируются и у
нас есть x между 1 и 10, то мы не знаем что такое x, потому что от 10 до
1,5, и не просто посчитать в х голове. Однако преимущество использования
логарифмических весов, которые мы видим исходные значения на оси.

Этот способ имеет преимущество, потому что мы видим исходные значения,
отображаемые на графике, что позволяет очень легко быстро увидеть,
с какими цифрами мы имеем дело.

```{r}
past_year <- 1970
gapminder %>%
  filter(year==past_year & !is.na(gdp)) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2")
```

Гистограмма выглядит точно так же. Разница заключается в том, что
в масштабах в оси х, вместо того, чтобы увидеть значение логарифма,
мы видим исходные значения на логарифмической шкале.

Гистограмма показала нам, что значения распределения доходов
показывают дихотомию. Однако гистограмма не показывает нам,
являются ли две группы стран западной и развивающейся.
Чтобы увидеть распределения по географическому региону, мы
сначала разбиваем данные на регионы, а затем изучаем распределение
для каждого.

Глядя на гистограммы или гладкие линии для каждого из них
не будут полезны. Вместо этого мы можем складывать box plots
рядом друг с другом.

```{r}
p <- gapminder %>%
  filter(year == past_year & !is.na(gdp)) %>%
  ggplot(aes(region, dollars_per_day))

p + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Mожем увидеть, что на самом деле существует западная по сравнению с
остальной дихотомии. Если внимательно посмотрить на график, увидим,
что Северная Америка, Северная Европа, Австралия, Новой Зеландии
и Западной Европы находятся на высоком уровне. Есть еще несколько
корректировок, которые можно сделать.

Для начала переупорядочим регионы по их среднему уровню дохода,
так же добавим цвет континента:

```{r}
p <- gapminder %>%
  filter(year == past_year & !is.na(gdp)) %>%
  mutate(region = reorder(region, dollars_per_day, FUN = median)) %>%
  ggplot(aes(region, dollars_per_day, fill = continent)) +
  geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("")

p
```

Теперь нужно изменить маштаб:

```{r}
p <-p + scale_y_continuous(trans = "log2")
p
```

Такой вид помогает видеть различия между странами с более низким доходом.
Например, мы видим разницу между африканским континентоми Азией.

Последнее что нужно сделать, что даст еще больше информации, состоит в том,
чтобы показать данные:

```{r}
p <- p + geom_point(show.legend = FALSE)
p
```

Во многих случаях мы не показываем данные, фактические отдельные
точки, потому что это добавляет слишком много беспорядка в график,
и это затуманивает сообщение. Но в этом конкретном примере у нас
не так много точек.

Проведенный анализ данных выявил две характеристики распределения
среднего дохода в 1970 году. Используя гистограмму, выявили бимодальное
распределение, которое больше всего относится к бедным и богатым странам.
Разбив по регионам и иследуя box plot, обнаружили, что в основном
богатые страны находятся в Европе и Северной Америке вместе
с Австралией, Новой Зеландией, а бедные страны занимают остальной мир.
Поэтому нужно определить вектор, который определяет регионы на Западе.

```{r}
west <- c("Western Europe", "Northern Europe", "Southern Europe", 
          "Northern America", "Australia and New Zeland")
```

Теперь сосредоточимся на сравнении различий в распределении во времени.
Начнем с подтверждения того, что бимодальность, наблюдавшаяся в 1970 году,
запада по сравнению с развивающейся мировой экономикой.
Делаем это, создавая гистограмму для ранее определенных групп.

```{r}
gapminder %>%
  filter(year == past_year & !is.na(gdp)) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2") +
  facet_grid(. ~ group)
```

Видим, что западные страны имеют более высокие доходы. Гистограмма
сдвинута вправо. Страны в развивающемся мире смещены влево.

Теперь нужно посмотреть, ухудшилось в 2010 году разделение по уровню
стран чем это было 40 лет назад? Сделаем это ограничив регион и год.

```{r}
present_year <- 2010
gapminder %>%
  filter(year %in% c(past_year, present_year) & !is.na(gdp)) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2") +
  facet_grid(year ~ group)
```

По гистограмме видим, что развивающийся мир смещен вправо больше,
чем Западный. Распределение доходов в развивающихся странах стало
ближе к западным.Прежде чем интерпретировать выводы этого графика
дальше. Нужно отметить, что в гистограммах 2010 года представлено
больше стран, чем в 1970-х годах.

Одной из причин этого является что после 1970 года было создано
несколько стран. Например, в 90-х годах Советский Союз разделился
на несколько стран, в том числе Россию и Украину.

Другая причина заключается в том, что за 2010 год доступно больше
данных для большего количества стран по сравнению с 1970 годом.
Поэтому нужно переделать график, но с использованием только
тех стран данные которых содержатся в обеих годах.

```{r}
country_list_1 <- gapminder %>%
  filter(year == past_year & !is.na(dollars_per_day)) %>% .$country
country_list_2 <- gapminder %>%
  filter(year == present_year & !is.na(dollars_per_day)) %>% .$country
country_list <- intersect(country_list_1, country_list_2)
```

В списке country_list 108 стран. Это примерно 86% от общей численности
населения. Таким образом, это подмножество должно быть представителем
всего мира. Сделаем график еще раз, но на этот раз используем только
подмножество стран, которые присутствуют данные в 1970 и 2010 годах.

```{r}
present_year <- 2010
gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day)) +
  geom_histogram(binwidth = 1, color = "black") +
  scale_x_continuous(trans = "log2") +
  facet_grid(year ~ group)
```

Теперь видно, что, хотя богатые страны стали немного богаче в процентах,
более бедные страны улучшили. Видно, что доля развивающихся стран,
зарабатывающих более 16 долларов США в день, значительно увеличивается.
Чтобы узнать, какие конкретные регионы улучшились больше всего, можно
переделать box plot, которые мы сделали ранее, но теперь добавили 2010 год.

```{r}
p <- gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  mutate(region = reorder(region, dollars_per_day, FUN = median)) %>%
  ggplot() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  xlab("") + scale_y_continuous(trans = "log2")
p + geom_boxplot(aes(region, dollars_per_day, fill = continent)) +
  facet_grid(year~.)
```

Теперь этот box plot немного сложно сравнивать, потому что мы пытаемся
сравнить box plot, которые находятся друг на друге. Полезно поставить их
рядом друг с другом.

Поскольку хотим сравнить каждый регион до и после, было бы удобно иметь
график 1970 года рядом с графиком в 2010 году.В целом, сравнение проще,
когда данные строятся рядом друг с другом. Поскольку год - это число,
мы превращаем его в фактор, так что каждый из них является категорией.

```{r}
p + geom_boxplot(aes(region, dollars_per_day, fill = factor(year)))
```

И мы можем видеть, какие страны улучшились больше всего. Например,
Восточная Азия, как она прошла от 8 вплоть до 64. И, наконец, мы отмечаем,
что если нас больше всего интересует сравнение до и после, имеет смысл
рассчитать коэффициенты или различия в логарифмическом масштабе. **(Код
расмотрен будет позже)**

Используя исследование данных, обнаружилось, что разрыв в доходах
между богатыми и бедными странами значительно сократился за последние
40 лет. 

```{r}
gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day)) +
  geom_density(fill = "gray") +
  scale_x_continuous(trans = "log2") +
  facet_grid(year~.)
```

Начнем с того, что график плотности распределения доходов в 1970 и 2010 гг.
получаем сообщение о том, что разрыв сокращается. В графике 1970-х годов видно
два четких режима, бедных и богатых. В 2010 году, похоже, некоторые из бедных
стран смещены вправо, закрывая разрыв.

Причиной такого изменения в распределении является то, что бедные страны
становятся богаче, а некоторые богатые страны становятся беднее. Чтобы сделать
это, все, что нужно сделать, это присвоить цвет группам, которые мы
идентифицировали во время исследования данных.

Если мы разделим мир на развивающиеся страны и на Запад, у нас есть 87
развивающихся стран и 21 западная страна.

```{r}
gapminder %>%
  filter(year == past_year & country %in% country_list) %>%
  mutate(group = ifelse (region %in% west, "West", "Developing")) %>%
  group_by(group)%>%
  summarise(n = n()) %>%
  knitr::kable()
```

Если мы наложим две плотности, по умолчанию будет отображаться площадь, представленная каждым распределением, до 1 независимо от размера каждой группы.
Похоже, что в каждой группе одинаковое число стран, что неверно.

```{r}
gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day, fill = group)) +
  geom_density(alpha = 0.5) +
  scale_x_continuous(trans = "log2") +
  facet_grid(year ~ .)
```

Чтобы площади плотностей были пропорциональны размеру групп, мы можем умножить
значения оси y на размер группы.

```{r}
p <- gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  mutate(group = ifelse(region%in%west, "West", "Developing")) %>%
  ggplot(aes(dollars_per_day, y = ..count.., fill = group)) +
  scale_x_continuous(trans = "log2") 

p + geom_density(alpha = 0.5) + facet_grid(year ~ .)
```

Обратите внимание, что теперь можно ясно видеть, что в развивающемся мире
больше стран. Если нужно, чтобы density был более гладким, можем изменить
аргумент bw.

```{r}
p + geom_density(alpha = 0.5, bw = 0.75) + facet_grid(year ~ .)
```

Этот грайик показывает, что происходит очень четко. Распространение
развивающегося мира меняется. Появляется третий режим, состоящий из стран,
которые больше всего сократили разрыв.

Можно сделать эту фигуру несколько более информативной.
Из анализа исследованных данных мы заметили, что многие из стран, которые
наиболее улучшили свое состаяник, были из Азии.

Нужно получить доступ к компонентам наших данных с помощью точечного заполнителя.

```{r}
gapminder <- gapminder %>% 
  mutate(group = case_when(
    .$region %in% west ~ "West",
    .$region %in% c("Eastern Asia", "South-Eastern Asia") ~ "East Asia",
    .$region %in% c("Caribbean", "Central America", "South America") ~ "Latin America",
    .$continent == "Africa" & .$region != "Northern Africa" ~ "Sub-Saharan Africa", 
    TRUE ~ "Others"
  ))
```

Назначаем группы в зависимости от региона.
Если регион на Западе, называем Запад.
Если регион находится в Восточной Азии, Южной Азии, называем его Восточной Азией.
Если регион находится в Карибском бассейне, Центральной Америке, Южной Америке,
называем это Латинской Америкой.
Если континент - это Африка, а регион - не Северная Африка,  будем называть ее
Африкой к югу от Сахары.
А потом все остальное будем называть другими.
Теперь превращаем эту групповую переменную в коэффициент, чтобы контролировать
порядок уровней.

```{r}
gapminder <- gapminder %>%
  mutate(group = factor(group, levels = c ("Others", "Latin America", "East Asia",
                                           "Sub-Saharan Africa", "West")))
```

Теперь можем легко построить плотность для каждого из них.

```{r}
p <- gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  ggplot(aes(dollars_per_day, y = ..count.., fill = group)) +
  scale_x_continuous(trans = "log2") 

p + geom_density(alpha = 0.5, bw = 0.75) + facet_grid(year ~ .)
```

Вот что они выглядят в 1970 и 2010 годах. График немного загроможден и его
трудно читать, для этого нужно использовать метод укладки, чтобы сделать
изображение четким.

```{r}
p + geom_density(alpha = 0.5, bw = 0.75, position = "stack") + facet_grid(year ~ .)
```

И теперь получается, что гистограммы или графики плотности укладываются
друг на друга друг над другом. Здесь ясно видно, что распределение из 
Восточной Азии и Латинской Америки и других стран заметно меняется вправо,
в то время как страны Африки к югу от Сахары остаются на прежнем уровне.
Обратите внимание, что упорядочиваем уровни групп, чтобы сначала была
построена плотность Запада, а затем и страны Африки к югу от Сахары.
Это помогает нам увидеть этот шаблон.

В качестве последнего момента отметим, что эти распределения взвешивают
каждую страну одинаково. Поэтому, если большая часть населения улучшается,
но живет в очень большой стране, такой как Китай, можем не оценить это.
Можем фактически взвешивать гладкие плотности, используя аргумент весового
сопоставления.

```{r}
gapminder %>%
  filter(year %in% c(past_year, present_year) & country %in% country_list) %>%
  group_by(year) %>%
  mutate(weight = population/sum(population)*2) %>%
  ungroup() %>%
  ggplot(aes(dollars_per_day, fill = group, weight = weight)) +
  scale_x_continuous(trans = "log2") +
  geom_density(alpha = 0.5, bw = 0.75, position = "stack") + 
  facet_grid(year ~ .)
```

Этот конкретный показатель очень четко показывает, как разрыв в распределении
доходов закрывается с большей частью бедных стран, оставшихся в Африке к югу
от Сахары.

В среднем некоторые регионы лучше других улучшаются в отношении здоровья и
экономического развития. Сосредоточимся на взаимосвязи между коэффициентами
выживания детей в стране и средним доходом.

Прежде найдем еще несколько областей, использующих одну функцию.
Собираемся найти Запад, Северную Африку, Восточную Азию, Южную Азию,
Латинскую Америку, Африку к югу от Сахары и острова Тихого океана.

```{r}
gapminder <- gapminder %>% 
  mutate(group = case_when(
    .$region %in% west ~ "West",
    .$region %in% "Northern Africa" ~ "Northern Africa",
    .$region %in% c("Eastern Asia", "South-Eastern Asia") ~ "East Asia",
    .$region == "Southern Asia" ~ "Southern Asia",
    .$region %in% c("Caribbean", "Central America", "South America") ~ "Latin America",
    .$continent == "Africa" & .$region != "Northern Africa" ~ "Sub-Saharan Africa", 
    .$region %in% c("Melanesia", "Micronesia", "Polynesia") ~ "Pacific Islands"
  ))
```

Начнем с сравнения этих величин по регионам.
Мы вычислим среднее значение.

```{r}
surv_income <- gapminder %>%
  filter(year %in% present_year & !is.na(gdp) & !is.na(infant_mortality) & 
           !is.na(group)) %>%
  group_by(group) %>%
  summarize(income = sum(gdp)/sum(population)/365, 
            infant_survival_rate = 1 - sum(infant_mortality/1000*population)/sum(population))
surv_income %>% arrange(income)
```

Показано резкое различие.
В то время как на Западе менее 0,5% детей умирают, в Африке к югу от Сахары
этот показатель выше 6%. Фактически, связь между этими двумя переменными почти
идеально линейна.

```{r}
surv_income %>%
  ggplot(aes(income, infant_survival_rate, label = group, color = group)) +
  scale_x_continuous(trans = "log2", limit = c(0.25, 150)) +
  scale_y_continuous(trans = "logit", limit = c(0.875, .9981), 
                     breaks = c(.85, .90, .95, .99, .995, .998)) +
  geom_label(size = 3, show.legend = FALSE)
```

На этом графике ввели использование предельного аргумента, который позволяет
изменить диапазон оси. Сделаем диапазон больше, чем потребности в данных,
потому что позже сравним этот график, который только что видели, с большей
изменчивостью. И нужно, чтобы диапазоны были одинаковыми.


Также был представлен аргумент breaks, который позволяет установить расположение
меток на оси. Наконец, вводим новое преобразование - логистическое преобразование.
Логическое или логическое преобразование для пропорциональной скорости p определяется следующим образом $f(p) = \log{(\frac{p}{1 - p})}$.

Когда p является долей или вероятностью, количество, которое регистрируется,
$\frac{p}{1 - p}$, называется коэффициентом.


И выбранное p - это популяция детей, которые выжили. Шансы говорят, сколько еще
детей выживет. Преобразование log делает эту величину симметричной. Если ставки
одинаковы, то лог-коэффициенты равны 0. Сгиб увеличивается или уменьшается,
соответственно, на положительные и отрицательные приращения.

Этот масштаб полезен, когда мы хотим выделить различия, близкие к 0 или около 1.
Для выживаемости это важно, потому что коэффициент выживаемости 90% неприемлем,
а выживаемость 99% относительно хороша. Предпочтительней был бы уровень выживаемости
ближе к 99,9%.

Основываясь на графике, который получили ранее, делаем заключение, что стране с
низким доходом суждено иметь низкую выживаемость? Делаем ли заключение о том,
что все показатели выживания в странах Африки к югу от Сахары ниже, чем в южной Азии,
что, в свою очередь, ниже, чем на островах Тихого океана и так далее? Прыгая к такому
выводу, основанному на графике, который показывает только средние значения, называется
экологической ошибкой.

Почти идеальная взаимосвязь между показателями выживаемости и доходами наблюдается
только для средних значений на региональном уровне. Когда показываем данные, видим
несколько более сложную историю. Что произойдет, когда посмотрим на каждую отдельную
страну.

```{r warning=FALSE}
library("ggrepel")

gapminder <- gapminder %>% 
  mutate(country_list_3 = case_when(
    .$country %in% "Singapore" ~ "Singapore",
    .$country %in% "Sweden" ~ "Sweden",
    .$country %in% "United States" ~ "United States",
    .$country %in% "Chile" ~ "Chile",
    .$country %in% "Serbia" ~ "Serbia",
    .$country %in% "Mauritius" ~ "Mauritius",
    .$country %in% "Tunisia" ~ "Tunisia",
    .$country %in% "Bolivia" ~ "Bolivia",
    .$country %in% "Botswana" ~ "Botswana",
    .$country %in% "Angola" ~ "Angola",
    .$country %in% "Cambodia" ~ "Cambodia",
    .$country %in% "Sudan" ~ "Sudan",
    .$country %in% "Haiti" ~ "Haiti",
    .$country %in% "Sierra Leone" ~ "Sierra Leone"
  ))

gapminder %>%
  filter(year %in% present_year & !is.na(gdp) & !is.na(infant_mortality) & 
           !is.na(group)) %>%
  group_by(group) %>%
  mutate(infant_survival = 1 - infant_mortality/1000) %>%
  ungroup() %>%
  ggplot(aes(dollars_per_day, infant_survival, label = country_list_3, color = group)) +
  scale_x_continuous(trans = "log2", limit = c(0.25, 150)) +
  scale_y_continuous(trans = "logit", limit = c(0.85, .9981), 
                     breaks = c(.85, .90, .95, .99, .995, .998)) +
  geom_point(alpha = .5) +
  geom_text_repel(check_overlap = TRUE) 
```

В частности, видим, что существует большая вариабельность. Видим, что страны из одних
и тех же регионов могут быть совершенно разными. И эти страны в пределах одного дохода
могут иметь разные показатели выживания. Например, в то время как в среднем страны Африки
к югу от Сахары имеют наихудшие результаты в области здравоохранения и экономики, в этой
группе существует большая изменчивость. Например, Маврикий и Ботсвана намного лучше,
чем Ангола и Сьерра-Леоне с Маврикием, сопоставимые с западными странами, и т. д..